<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Stellar Analysis</title>
		<style>
			body {
				background-color: rgb(246, 245, 242);
				font-family: times, sans-serif
			}
			header {
				padding: 20px;
			}
			h1 {
				margin-top: 0px;
				margin-left: 20px;
				padding-top: 30px;
				padding-left: 30px;
				padding-bottom: 20px;
				background-color: rgb(186, 171, 144);
			}
			h2 {
				margin-left: 50px;
			}
			h3 {
				margin-left: 20px;
			}
			p {
				padding-left: 50px;
			}
			.box {
				display: block;
				margin-left: 20px;
				margin-top: -1em;
				margin-bottom: 1em;
				padding: 1em;
				padding-left: 30px;
				background-color: rgb(255, 255, 255);
			}
			code {
				word-break: break-all;
			}
		</style>
	</head>
	<body>

		<header>
			<a href="https://weizenbaum-institut.de/">
				<svg height="50" viewBox="0 0 216 65" role="img">
					<path d="M28.55 9.59l-6.23 17.49L16.7 9.59h-2.14L8.43 27.13 3.15 9.59H1l6.35 19.7h2.02l6.31-17.66 5.69 17.66h1.89l7.4-19.7zm81.89-.29c-7.45 0-7.45 5.6-7.45 7.15v12.84h1.92V16.74c0-1.55 0-5.8 5.53-5.8s5.57 4.26 5.57 5.8v12.55h1.92V16.45c0-1.55-.04-7.15-7.49-7.15zM22.56 43.7c-7.45 0-7.45 5.6-7.45 7.15v12.84h1.92V51.14c0-1.55 0-5.8 5.53-5.8s5.57 4.26 5.57 5.8v12.55h1.92V50.85c.01-1.54-.03-7.15-7.49-7.15zM207.79 9.3c-3.84 0-5.49 1.83-6.19 3.86-.82-2.01-2.6-3.86-6.35-3.86-6.57 0-7.18 4.76-7.23 7.15v12.84h1.92V16.87c0-2.38.52-5.94 5.31-5.94 4.5 0 5.29 3.4 5.29 5.94v12.42h1.92V16.66c.05-2.18.89-5.73 5.33-5.73 4.69 0 5.29 3.36 5.29 5.8v12.55H215V16.62c0-2.21-.65-7.32-7.21-7.32zm-27.76.29v12.55c0 1.88-.28 5.8-5.64 5.8-5.32 0-5.69-3.92-5.69-5.8V9.59h-1.92v12.53c0 1.9.35 7.45 7.62 7.45 6.83 0 7.51-5.02 7.56-7.15V9.59h-1.93zm-71.09 34.4v12.55c0 1.88-.28 5.8-5.64 5.8-5.32 0-5.69-3.92-5.69-5.8V43.99h-1.92v12.53c0 1.9.35 7.45 7.62 7.45 6.83 0 7.51-5.02 7.56-7.15V43.99h-1.93zM55.4 9.59h1.92v19.7H55.4z"></path>
					<ellipse cx="56.37" cy="4.37" rx="1.64" ry="1.68"></ellipse>
					<path d="M7.07 43.99h1.92v19.7H7.07z"></path>
					<ellipse cx="8.03" cy="38.77" rx="1.64" ry="1.68"></ellipse>
					<path d="M71.52 43.99h1.92v19.7h-1.92z"></path>
					<ellipse cx="72.49" cy="38.77" rx="1.64" ry="1.68"></ellipse>
					<path d="M96.89 23.35c-.21 1.06-1.31 6.25-7.7 6.25-5.54 0-8.15-3.9-8.15-10.67 0-5.69 2.84-9.61 8.23-9.61 4.31 0 8.01 2.21 8.01 9.24 0 .42 0 .91-.03 1.29H86.43v-1.71h8.87c0-4.42-1.76-7.19-6.02-7.19-3.81 0-6.31 2.64-6.31 8.09 0 5.67 1.9 8.92 6.3 8.92 3.4 0 5.22-2.09 5.64-4.61h1.98zm-47.76 0c-.21 1.06-1.31 6.25-7.7 6.25-5.54 0-8.15-3.9-8.15-10.67 0-5.69 2.84-9.61 8.23-9.61 4.31 0 8.01 2.21 8.01 9.24 0 .42 0 .91-.03 1.29H38.67v-1.71h8.87c0-4.42-1.76-7.19-6.02-7.19-3.81 0-6.31 2.64-6.31 8.09 0 5.67 1.9 8.92 6.3 8.92 3.4 0 5.22-2.09 5.64-4.61h1.98zm15.58 4.31l12.55-16.44V9.59H62.82v1.63h12.44l-12.5 16.44v1.63h14.77v-1.63zM132 9.3c-2.15 0-3.54.87-3.54.87l.87 1.44s1-.67 2.67-.67c5.93 0 5.5 7.07 5.5 8.51 0 1.8-.33 8.49-5.83 8.49-5.25 0-6.12-4.33-6.12-8.49V1h-1.92v18.95c.02 3.44.4 9.61 8.04 9.61 6.25 0 7.75-5.99 7.75-10.11S138.44 9.3 132 9.3zm19.87-.04c3.42 0 7.37 1.48 7.37 6.07v9.6c0 1.47.53 3.41 3.04 2.45v1.69s-3.41 1.18-4.37-2.41c-.35.54-1.7 2.87-6.55 2.87-4.81 0-7.66-1.9-7.66-6 0 0-.35-7.34 10.93-5.04l-.4 1.6s-8.56-1.71-8.56 3.21c0 4.09 3.17 4.63 5.56 4.63 1.35 0 6.1-.12 6.1-5.17v-7.11c0-1.52-.4-4.73-5.37-4.73-4.96 0-5.08 2.96-5.1 3.25h-1.94c-.02.01.29-4.91 6.95-4.91zm-92.46 49.2V45.63h5.69V44h-5.69v-5.1h-1.92v5.09h-3.52v1.63h3.52v12.84c0 4.15 3.29 6.21 8 5.3v-1.71c0 .01-6.08 1.72-6.08-3.59zm24.86 0V45.63h5.69V44h-5.69v-5.1h-1.92v5.09h-3.52v1.63h3.52v12.84c0 4.15 3.29 6.21 8 5.3v-1.71c0 .01-6.08 1.72-6.08-3.59zm36.74 0V45.63h5.69V44h-5.69v-5.1h-1.92v5.09h-3.52v1.63h3.52v12.84c0 4.15 3.29 6.21 8 5.3v-1.71c0 .01-6.08 1.72-6.08-3.59zM49.96 48.45s-.21-4.8-6.96-4.8c-6.1 0-7.12 3.27-7.12 5.11 0 3.51 3.37 5.06 6.45 5.46 2.82.37 6.12.63 6.12 3.97 0 3.44-3.1 4.15-5.52 4.15-2.85 0-5.62-1.08-5.62-4.31h-2.04c0 .61.19 6.08 7.75 5.96 7.35-.11 7.35-4.25 7.35-5.84 0-2.14-.79-4.99-6.83-5.59-5.7-.56-5.71-3.43-5.71-3.89 0-.65-.04-3.34 5.04-3.34 5.37 0 5.17 3.11 5.17 3.11h1.92z"></path>
				</svg>
			</a>
		</header>

		<h1>Stellar Network Analysis</h1>

		<p>
		Interactive analyses of the <a href="https://www.stellar.org">Stellar</a> public network using <a href="https://github.com/wiberlin/fbas_analyzer"><code>fbas_analyzer</code></a><!--(commit <code>7fce4b34</code>)-->. The data used in the analysis is provided by  <a href="https://www.stellarbeat.io/">Stellarbeat</a>.
		</p>
		</head>
		<body>
			<label for="date">Date:</label>
			<input type="date" id="date" name="date" min="2019-07-01"><br>
			<label for="time">Time:</label>
			<input type="time" id="time" name="time" value="00:00"><br>
			<input name="to_merge" id=merge_box type="checkbox" checked=checked onclick="make_chart_from_csv_url('daily_chart_merged_by_org', 'stellarbeat_daily.csv'); maybe_change_analysis()">
			<label for="to_merge"> Merge by organizations</label><br>
			<input name="to_describe" id=describe_box type="checkbox" checked=false >
			<label for="to_describe"> Describe (Output metrics instead of lists of node lists)</label><br>
			<button id="submit-btn" type="button" onclick="call_stellarbeat_on_input()">
				Sumbit
			</button>
			<script>
			window.onload = function() {
				document.getElementById('date').value = '';
				document.getElementById('time').value = '';
				document.getElementById('merge_box').checked = true;
				document.getElementById('describe_box').checked = false;
			}
			</script>
			<p>
			The following plots use nodes and organizations data from <a href="https://stellarbeat.io">stellarbeat.io</a>.
			For each analyzed network snapshot, they show the size of the top tier, the mean, minimum and maximum of all minimal blocking set sizes, and the mean, minimum and maximum of all minimal splitting set sizes.
			</p>
			<canvas id="daily_chart_merged_by_org"></canvas>
			<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
			<script src="https://d3js.org/d3.v5.min.js"></script>
			<script charset="utf-8">
				var current_nodes;
				var current_orgs;
				var timestamp;
				var stellarbeat_timestamp; 
				var should_merge = document.getElementById("merge_box").checked;
				var should_describe = document.getElementById("describe_box").checked;
				make_chart_from_csv_url('daily_chart_merged_by_org', 'stellarbeat_daily.csv');

  function make_chart_from_csv_url(canvas_id, csv_url) {
	const merged_title = "Merged by organization (nodes by the same organization count as 1)";
	const raw_title = "Raw nodes (each physical node counts as 1)";
	should_merge = document.getElementById("merge_box").checked;
	d3.csv(csv_url).then(function(csv_data) { make_chart_from_csv_data(canvas_id, csv_data); });
  }

  function make_chart_from_csv_data(canvas_id, csv_data) {

	Chart.defaults.global.defaultColor = 'rgba(0, 0, 0, 0)';

	var colors = {
	  tt:        'rgba(70, 105, 90, 1)',
	  mbs:       'rgba(35, 90, 130, 1)',
	  mbs_light: 'rgba(35, 90, 130, 0.35)',
	  mss:       'rgba(190, 85, 45, 1)',
	  mss_light: 'rgba(190, 85, 45, 0.35)'
	};

	var chart_data = [];
	if (should_merge == false) {
	chart_data = {
	  labels: csv_data.map(function(d) {return d.label}),
	  datasets: [{
		data: csv_data.map(function(d) {return d.top_tier_size}),
		label: '|top tier|',
		borderColor: colors.tt,
		steppedLine: true,
		fill: -1
	  }, {
		data: csv_data.map(function(d) {return d.mbs_mean}),
		label: 'mean(|minimal blocking sets|)',
		borderColor: colors.mbs,
		backgroundColor: colors.mbs_light,
		steppedLine: true,
		fill: -1
	  }, {
		data: csv_data.map(function(d) {return d.mbs_min}),
		label: 'min(|minimal blocking sets|)',
		borderWidth: 0,
		backgroundColor: colors.mbs_light,
		steppedLine: true,
		fill: 1
	  }, {
		data: csv_data.map(function(d) {return d.mbs_max}),
		label: 'max(|minimal blocking sets|)',
		borderWidth: 0,
		backgroundColor: colors.mbs_light,
		steppedLine: true,
		fill: 1
	  }, {
		data: csv_data.map(function(d) {return d.mss_mean}),
		label: 'mean(|minimal splitting sets|)',
		borderColor: colors.mss,
		backgroundColor: colors.mss_light,
		steppedLine: true,
		fill: -1
	  }, {
		data: csv_data.map(function(d) {return d.mss_min}),
		label: 'min(|minimal splitting sets|)',
		borderWidth: 0,
		backgroundColor: colors.mss_light,
		steppedLine: true,
		fill: 4
	  }, {
		data: csv_data.map(function(d) {return d.mss_max}),
		label: 'max(|minimal splitting sets|)',
		borderWidth: 0,
		backgroundColor: colors.mss_light,
		steppedLine: true,
		fill: 4
	  }]
	};
	} else {
	chart_data = {
	  labels: csv_data.map(function(d) {return d.label}),
	  datasets: [{
		data: csv_data.map(function(d) {return d.orgs_top_tier_size}),
		label: '|top tier|',
		borderColor: colors.tt,
		steppedLine: true,
		fill: -1
	  }, {
		data: csv_data.map(function(d) {return d.orgs_mbs_mean}),
		label: 'mean(|minimal blocking sets|)',
		borderColor: colors.mbs,
		backgroundColor: colors.mbs_light,
		steppedLine: true,
		fill: -1
	  }, {
		data: csv_data.map(function(d) {return d.orgs_mbs_min}),
		label: 'min(|minimal blocking sets|)',
		borderWidth: 0,
		backgroundColor: colors.mbs_light,
		steppedLine: true,
		fill: 1
	  }, {
		data: csv_data.map(function(d) {return d.orgs_mbs_max}),
		label: 'max(|minimal blocking sets|)',
		borderWidth: 0,
		backgroundColor: colors.mbs_light,
		steppedLine: true,
		fill: 1
	  }, {
		data: csv_data.map(function(d) {return d.orgs_mss_mean}),
		label: 'mean(|minimal splitting sets|)',
		borderColor: colors.mss,
		backgroundColor: colors.mss_light,
		steppedLine: true,
		fill: -1
	  }, {
		data: csv_data.map(function(d) {return d.orgs_mss_min}),
		label: 'min(|minimal splitting sets|)',
		borderWidth: 0,
		backgroundColor: colors.mss_light,
		steppedLine: true,
		fill: 4
	  }, {
		data: csv_data.map(function(d) {return d.orgs_mss_max}),
		label: 'max(|minimal splitting sets|)',
		borderWidth: 0,
		backgroundColor: colors.mss_light,
		steppedLine: true,
		fill: 4
	  }]
	};

	}
	
	var chart_text;
	if (should_merge) {
		chart_text = "Merged by organization (nodes by the same organization count as 1)"
	} else {
		chart_text = "Raw nodes (each physical node counts as 1)";
	}

	var options = {
	responsive: true,
	title: {
		display: true,
		text: chart_text,
	},
	  scales: {
		yAxes: [{
		  ticks: {
			beginAtZero: true,
		  }
		}]
	  },
	  elements: {
		point: {
		  radius: 0,
		  hitRadius: 5
		},
	  },
	  legend: {
		labels: {
			 filter: function(legendItem, data) {
				  return !legendItem.text.startsWith('min') && !legendItem.text.startsWith('max')
			 }
		}
	  }
	};

	var ctx = document.getElementById(canvas_id).getContext('2d');

	var chart = new Chart(ctx, {
	  type: 'line',
	  data: chart_data,
	  options: options
	});
	document.getElementById(canvas_id).onclick = function(evt) {
	  var activePoint = chart.getElementAtEvent(event);

		// make sure click was on an actual point
		  if (activePoint.length > 0) {
				var clickedDatasetIndex = activePoint[0]._datasetIndex;
				var clickedElementindex = activePoint[0]._index;
				var label = chart.data.labels[clickedElementindex];
				var value = chart.data.datasets[clickedDatasetIndex].data[clickedElementindex];     
				console.log("Clicked: " + label + " - " + value);
				call_stellarbeat_on_click(label);
			}
	};
  }
			</script>															  
			<div id="text-id"></div>
			<script>
				const div = document.getElementById('text-id');
	function write_to_div(text) {
		div.innerHTML = div.innerHTML + "<br>" + text;
		div.innerHTML = div.innerHTML + "<br>";
	}
	window.write_to_div = write_to_div
			</script>
			<script type="module"></script> 
			</script>
			<script type="module">
				import init, {fbas_analysis} from './pkg/stellar_analysis.js';
			async function initialise() {
				await init();
			}
			initialise();
		async function run(fbas, orgs, should_merge, should_describe) {
			var results = fbas_analysis(fbas, orgs, should_merge, should_describe)
			console.log(results)
			return results
		}
		window.run = run
			</script>
			<script>
				function call_stellarbeat_on_input() {
					const date = document.getElementById('date');
					const time = document.getElementById('time');
					var url = "https://api.stellarbeat.io/v2/all?at=" + date.value + time.value;
					console.log(url);
					timestamp = date.value + "T" + time.value;
					console.log("timestamp: ", timestamp );
					var xhr = new XMLHttpRequest();
					xhr.open("GET", url);
					xhr.send();
					xhr.onload = function() {
						console.log(xhr.status);
						console.log(xhr.response);
						fbas = xhr.response;
						prepare_fbas_string(timestamp, fbas);
						return xhr.response;
					}
				}
window.call_stellarbeat_on_input = call_stellarbeat_on_input
			</script>
			<script>
				function call_stellarbeat_on_click(clicked_date) {
					const time = document.getElementById('time');
					var url = "https://api.stellarbeat.io/v2/all?at=" + clicked_date + time.value;
					console.log(url);
					timestamp = clicked_date + "T" + time.value;
					console.log("timestamp: ", timestamp );
					var xhr = new XMLHttpRequest();
					xhr.open("GET", url);
					xhr.send();
					xhr.onload = function() {
						console.log(xhr.status);
						console.log(xhr.response);
						fbas = xhr.response;
						prepare_fbas_string(timestamp, fbas);
						return xhr.response;
					}
				}
window.call_stellarbeat_on_click = call_stellarbeat_on_click
			</script>
			<script>
				function prepare_fbas_string(timestamp, text) {
					var js_object = JSON.parse(text);
					const stellarbeat_nodes = JSON.stringify(js_object[Object.keys(js_object)[0]]);
					const stellarbeat_orga = JSON.stringify(js_object[Object.keys(js_object)[1]]);
					stellarbeat_timestamp = JSON.stringify(js_object[Object.keys(js_object)[2]]);
					current_nodes = stellarbeat_nodes;
					current_orgs = stellarbeat_orga;
					console.log(text.length);
					fbas_from_stellarbeat = stellarbeat_nodes;
					var should_merge = document.getElementById("merge_box").checked;
					var should_describe = document.getElementById("describe_box").checked;
					console.log("to_merge: ", should_merge);
					console.log("to_describe: ", should_describe);
					var promise_results = run(fbas_from_stellarbeat, stellarbeat_orga, should_merge, should_describe);
					var resolved_results = promise_results.then(function(value) {
						log_results(timestamp, stellarbeat_timestamp, value)
					});
					window.prepare_fbas_string = prepare_fbas_string
				}
			</script>
			<script charset="utf-8">
				function maybe_change_analysis() {
					if (current_nodes || current_orgs) {
						should_merge = document.getElementById("merge_box").checked;
						should_describe = document.getElementById("describe_box").checked;
						var promise_results = run(current_nodes, current_orgs, should_merge, should_describe);
						var resolved_results = promise_results.then(function(value) {
							log_results(timestamp, stellarbeat_timestamp, value)
						});
					}
				}
			</script>
			<script>
				function log_results(timestamp, stellarbeat_timestamp, results) {
					div.innerHTML = "";

					write_to_div("<b>Requested analysis of the Stellar Public Network on " + timestamp + ". <br> The analyzed FBAS has the timestamp" + stellarbeat_timestamp + "." + "</b>");
					if (should_describe) {
						write_to_div('"Set of sets"-type results are described as: <br> [#sets, #distinct_nodes, [min_set_size, max_set_size, mean_set_size],' 
								+ ' [#sets_with_size_0, #sets_with_size_1, ..., #sets_with_max_set_size]]');
					}

					write_to_div("minimal quorums: " + JSON.stringify(results.minimal_quorums, null, 4).replace(/\\/g, ""));
					write_to_div("We found " + results.minimal_quorums_size + " minimal_quorums.");

					if (results.has_intersection) {
						write_to_div("All quorums intersect 👍");
					} else {
						write_to_div("Some quorums don't intersect 👎 Safety severely threatened for some nodes!<br>(Also, the remaining results here might not make much sense.)");
						;
					}

					write_to_div("blocking_sets: " +  JSON.stringify(results.minimal_blocking_sets, null, 4).replace(/\\/g, ""));

					write_to_div("We found " + results.minimal_blocking_sets_size + " minimal blocking sets (minimal indispensable sets for global liveness). Control over any of these sets is sufficient to compromise the liveness of all nodes and to censor future transactions.");

					write_to_div("splitting sets: " + JSON.stringify(results.minimal_splitting_sets, null, 4).replace(/\\/g, ""));

					write_to_div("We found " + results.minimal_splitting_sets_size + " minimal splitting sets (minimal indispensable sets for safety). Control over any of these sets is sufficient to compromise safety by undermining the quorum intersection of at least two quorums.");

					write_to_div("top_tier: "+ JSON.stringify(results.top_tier), null, 4);

					write_to_div("There is a total of " + results.top_tier_size + " distinct nodes involved in all of these sets (this is the \"top tier\")." );
				}
window.log_results = log_results
			</script>
		</body>
</html>
